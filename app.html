<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FarmChain — Tek Sayfa Uygulama</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0d18; --ink:#e9eef3; --muted:#a8b1c4; --border:rgba(255,255,255,.12);
      --bg-image: url('assets/bg-farm.jpg');   /* istersen değiştir ya da kaldır */
      --bg-overlay: rgba(10,13,24,.70);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;color:var(--ink);font:15px/1.6 "Inter",system-ui,Segoe UI,Roboto,Arial;
      background:
        linear-gradient(0deg,var(--bg-overlay),var(--bg-overlay)),
        var(--bg-image) center/cover no-repeat fixed;
    }
    @media (max-width:900px){ body{ background-attachment: scroll; } }

    .btn{padding:.55rem .8rem;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.1)}
    .btn.em{background:linear-gradient(135deg,#34d399,#14b8a6);border-color:transparent;color:#052017;font-weight:700}
    .btn.em:hover{filter:brightness(1.05)}
    .pill{padding:.4rem .6rem;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.06);color:#e9eef3}
    .muted{color:var(--muted)}
    .card{border:1px solid var(--border);background:rgba(255,255,255,.04);border-radius:16px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hide{display:none!important}
    .tag{padding:.2rem .5rem;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.05);color:#e9eef3;font-size:12px}

    header.top{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);background:rgba(10,13,24,.8);backdrop-filter:blur(10px);}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,#34d399,#14b8a6);color:#052017;font-weight:800}

    .app{display:grid;grid-template-columns:260px 1fr;min-height:100svh}
    @media (max-width:900px){.app{grid-template-columns:1fr}}
    aside.sidebar{padding:16px;border-right:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03))}
    nav.nav{display:grid;gap:8px}
    nav.nav .btn{width:100%;text-align:left}

    main{padding:16px}
    .grid{display:grid;gap:14px}
    .grid-2{grid-template-columns:repeat(2,1fr)}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:1100px){.grid-2,.grid-3{grid-template-columns:1fr}}

    table{width:100%;border-collapse:collapse;color:#dbe4f3}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.08)}
    th{text-align:left}
    .right{text-align:right}

    .land{aspect-ratio:4/3;border-radius:12px;border:1px dashed rgba(255,255,255,.25);display:grid;place-items:center;position:relative}
    .land.planted{border-style:solid;background:linear-gradient(180deg, rgba(52,211,153,.15), rgba(255,255,255,.03))}
    .land .timer{position:absolute;bottom:8px;left:8px;font-size:12px;opacity:.85}

    #siloModal .card{box-shadow:0 20px 60px rgba(0,0,0,.5);animation:popIn .2s ease}
    @keyframes popIn{from{opacity:0;transform:scale(.97)}to{opacity:1;transform:scale(1)}}
  </style>
</head>
<body>

  <!-- AUTH -->
  <section id="authView" class="card" style="max-width:520px;margin:10vh auto;">
    <div class="row" style="justify-content:space-between">
      <div class="brand"><div class="logo">🌱</div><div><div style="font-size:12px;letter-spacing:.18em;color:#bfffe6">FARMCHAIN</div><div style="font-weight:800">Giriş / Kayıt</div></div></div>
    </div>
    <div class="row" style="margin-top:12px">
      <input id="farmName" class="pill" placeholder="Çiftlik adı (kayıt için)" style="flex:1;min-width:200px">
    </div>
    <div class="row" style="margin-top:8px">
      <input id="email" class="pill" type="email" placeholder="E‑posta" style="flex:1;min-width:200px">
      <input id="password" class="pill" type="password" placeholder="Şifre" style="flex:1;min-width:160px">
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnLogin" class="btn">Giriş Yap</button>
      <button id="btnSignup" class="btn">Kayıt Ol</button>
      <span class="muted" id="authHint">Kayıt için e‑posta doğrulaması gerekebilir.</span>
    </div>
    <!-- Admin başlangıç seçenekleri -->
    <div class="row" style="margin-top:6px">
      <label class="muted" style="display:flex;align-items:center;gap:8px;cursor:pointer">
        <input id="startAsAdmin" type="checkbox">
        <span>Admin paneliyle başla (yetkim varsa)</span>
      </label>
      <button id="btnLoginAsAdmin" class="btn">Admin Girişi</button>
    </div>
  </section>

  <!-- APP -->
  <section id="appView" class="hide">
    <header class="top">
      <div class="brand">
        <div class="logo">🌱</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div>
            <div style="font-size:11px;letter-spacing:.18em;color:#bfffe6">FARMCHAIN</div>
            <div id="farmTitle" style="font-weight:800">Yükleniyor…</div>
          </div>
          <!-- Mod geçiş düğmesi (sadece adminlerde görünür) -->
          <button id="btnRoleSwitch" class="btn" style="display:none">Admin</button>
        </div>
      </div>
      <div class="row">
        <span id="balance" class="pill">💰 —</span>
        <button id="btnLogout" class="btn">Çıkış</button>
      </div>
    </header>

    <div class="app">
      <aside class="sidebar">
        <nav class="nav" id="nav">
          <button class="btn" data-route="#game">🌱 Çiftlik</button>
          <button class="btn" data-route="#market">🛒 Market</button>
          <button class="btn" data-route="#crypto">⚡ Kripto</button>
          <button class="btn" data-route="#profile">👤 Profil</button>
        </nav>
        <div class="card" style="margin-top:12px"><span class="muted">Topraktan token’a: ürün sat, FC kazan.</span></div>
      </aside>

      <main>
        <!-- Silo bar -->
        <div id="siloBar" class="card" style="margin:0 0 12px 0">
          <div class="row">
            <strong>🏚️ Silo</strong>
            <span id="siloCap" class="pill">— / —</span>
            <span id="siloLevel" class="pill">Seviye 1</span>
            <button id="btnOpenSilo" class="btn">Silo’yu Aç</button>
            <button id="btnUpgradeSilo" class="btn">Yükselt</button>
            <span id="siloUpgradeInfo" class="muted">Ücret: — FC</span>
          </div>
        </div>

        <!-- ROUTES -->
        <section id="route-game">
          <div class="grid grid-3">
            <div class="card">
              <div class="row" style="justify-content:space-between"><strong>Tarlalar</strong></div>
              <div class="grid grid-2" id="lands"></div>
              <div class="muted" style="margin-top:8px">“Ekim Yap” → 10sn → “Hasat”.</div>
            </div>

            <div class="card">
              <strong>Envanter</strong>
              <div class="row" style="margin:8px 0">
                <button class="btn" id="btnAddSeed">+ Tohum Ekle</button>
                <button class="btn" id="btnPlantDemo">🌾 Ekim (10sn)</button>
              </div>
              <table><thead><tr><th>Ürün</th><th class="right">Miktar</th></tr></thead><tbody id="invBody"></tbody></table>
              <div id="status" class="muted" style="margin-top:8px"></div>
            </div>

            <div class="card">
              <strong>Hızlı İşlemler</strong>
              <div class="row" style="margin-top:8px">
                <button class="btn" id="btnSellWheat">Buğday Sat (×1) — demo</button>
              </div>
            </div>
          </div>
        </section>

        <section id="route-market" class="hide">
          <!-- Vitrin sekmeleri -->
          <div class="row" style="margin-bottom:10px">
            <button id="tab-market" class="btn active">🛒 Ürünler</button>
            <button id="tab-crypto" class="btn">⚡ Tokenlar</button>
            <span class="pill" id="badge-market">Market</span>
            <span class="pill" id="badge-crypto" style="opacity:.8">Kripto</span>
          </div>
          <!-- Vitrin görünümleri -->
          <div id="view-market" class="grid grid-2" style="margin-bottom:16px"></div>
          <div id="view-crypto" class="grid grid-2 hide" style="margin-bottom:16px"></div>

          <div class="grid grid-2">
            <div class="card">
              <strong>Satışa Koy (demo)</strong>
              <div class="row" style="margin-top:8px">
                <select id="sellItem" class="pill">
                  <option value="bugday">Buğday</option>
                  <option value="tohum">Tohum</option>
                </select>
                <input id="sellAmount" class="pill" type="number" min="1" value="1" style="width:90px">
                <input id="sellPrice" class="pill" type="number" min="1" value="10" style="width:110px">
                <button id="btnList" class="btn">Listele</button>
              </div>
              <div class="muted">Gerçek ilanlar için tablo ekleyebiliriz.</div>
            </div>
            <div class="card">
              <strong>Pazar</strong>
              <table><thead><tr><th>Ürün</th><th class="right">Fiyat (FC)</th><th class="right">Adet</th><th class="right">İşlem</th></tr></thead><tbody id="marketBody"></tbody></table>
            </div>
          </div>
        </section>

        <section id="route-crypto" class="hide">
          <div class="grid grid-2">
            <div class="card">
              <strong>Mini Rig</strong>
              <div class="muted">Dakikada 1 FC üretir.</div>
              <div class="row" style="margin-top:8px">
                <button class="btn" id="btnCollect">Topla</button>
                <span id="rigInfo" class="pill">Son toplama: —</span>
              </div>
            </div>
            <div class="card"><strong>FC (Farm Coin)</strong><div class="muted">Oyun içi para birimi.</div></div>
          </div>
        </section>

        <section id="route-profile" class="hide">
          <div class="card"><strong>Profil</strong><div id="profileBox" class="muted">Yükleniyor…</div></div>
        </section>

        <!-- ========== ADMIN ROUTE (tamamı) ========== -->
        <section id="route-admin" class="hide">
          <!-- Özet kutular -->
          <div class="grid grid-3" style="margin-bottom:16px">
            <div class="card"><div class="muted">Toplam Oyuncu</div><div id="sumPlayers" style="font-size:28px;font-weight:800">—</div></div>
            <div class="card"><div class="muted">Toplam FC</div><div id="sumFC" style="font-size:28px;font-weight:800">—</div></div>
            <div class="card"><div class="muted">Ortalama Silo</div><div id="avgSilo" style="font-size:28px;font-weight:800">—</div></div>
          </div>

          <!-- 👑 Admin Yönetimi kartı -->
          <div class="card" style="margin-bottom:14px">
            <div class="row">
              <strong>👑 Admin Yönetimi</strong>
              <input id="adminUserId" class="pill" placeholder="Kullanıcı user_id" style="min-width:260px">
              <button id="btnMakeAdmin" class="btn">Admin Yap</button>
              <button id="btnRemoveAdmin" class="btn">Admini Kaldır</button>
            </div>
            <div class="row" style="margin-top:10px">
              <input id="adminEmail" class="pill" type="email" placeholder="veya e‑posta ile ara → admin yap/kaldır" style="min-width:320px">
              <button id="btnMakeAdminEmail" class="btn">E‑posta → Admin Yap</button>
              <button id="btnRemoveAdminEmail" class="btn">E‑posta → Admini Kaldır</button>
            </div>
            <div class="muted" style="margin-top:6px">
              Not: E‑posta → user_id eşleşmesi <code>public.profiles</code> tablosundan yapılır. Kayıt olurken profil satırı eklenir.
            </div>
          </div>

          <div class="card" style="margin-bottom:14px">
            <strong>Çiftlikler</strong>
            <div class="row" style="margin:8px 0">
              <input id="q" class="pill" placeholder="Ara: farm adı" style="min-width:260px">
              <button id="btnSearch" class="btn">Ara</button>
            </div>
            <table><thead><tr><th>Kullanıcı</th><th>Çiftlik</th><th class="right">Tutorial</th></tr></thead><tbody id="tbodyFarms"></tbody></table>
          </div>

          <div class="card" style="margin-bottom:14px">
            <strong>Silo & Bakiye</strong>
            <table><thead><tr><th>Kullanıcı</th><th class="right">Bakiye</th><th class="right">Seviye</th><th class="right">Kapasite</th></tr></thead><tbody id="tbodyWallets"></tbody></table>
          </div>

          <div class="card">
            <strong>Envanter</strong>
            <table><thead><tr><th>Kullanıcı</th><th>Ürün</th><th class="right">Miktar</th><th>Kategori</th></tr></thead><tbody id="tbodyInv"></tbody></table>
          </div>
        </section>
      </main>
    </div>
  </section>

  <!-- Silo Modal -->
  <div id="siloModal" class="hide" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:grid;place-items:center;z-index:100;">
    <div class="card" style="width:min(900px,95vw);max-height:85vh;overflow:auto">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:.2rem 0">🏚️ Silo İçeriği</h3>
        <button class="btn" id="btnCloseSilo">Kapat</button>
      </div>
      <div class="muted" style="margin-bottom:8px">Ürünler kategorilere göre listelenir.</div>
      <div id="siloTabs" class="row" style="margin-bottom:8px">
        <button class="btn" data-cat="hepsi">Hepsi</button>
        <button class="btn" data-cat="bitkisel">Bitkisel</button>
        <button class="btn" data-cat="yem">Yemler</button>
        <button class="btn" data-cat="hayvansal">Hayvansal</button>
        <button class="btn" data-cat="süt">Süt</button>
        <button class="btn" data-cat="genel">Genel</button>
      </div>
      <table><thead><tr><th>Ürün</th><th>Kategori</th><th class="right">Miktar</th></tr></thead><tbody id="siloBody"></tbody></table>
    </div>
  </div>

  <!-- Supabase + App Script -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // 👉 Supabase bilgilerini doldur
    const SUPA_URL  = 'https://gukdmxepdgwrwniectnq.supabase.co
';
    const SUPA_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd1a2RteGVwZGd3cnduaWVjdG5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NzgyODAsImV4cCI6MjA3MTQ1NDI4MH0.57j4LbCHdhoaYl05PBTRjNyQAV3SxvL07GUredTDWZU';

    const supa = supabase.createClient(SUPA_URL, SUPA_ANON);

    // ---- Global state
    let currentUser=null, isAdmin=false;
    let tutorialStep=0;
    let lands=[];
    let marketItems=[];
    let rigLast=null;
    let silo={ level:1, capacity:20 };
    let currentMode = localStorage.getItem('fc_mode') || 'player'; // 'player'|'admin'

    // ---- Helpers
    const $  = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const now= ()=>new Date();

    // ---- Router
    function go(route){
      ['#game','#market','#crypto','#profile','#admin'].forEach(r=>{
        const sec = document.getElementById('route-'+r.slice(1));
        if(sec) sec.classList.toggle('hide', r!==route);
      });
      $$('#nav .btn').forEach(b=>b.classList.toggle('active', b.dataset.route===route));
      if(location.hash!==route) location.hash = route;
    }
    window.addEventListener('hashchange', ()=>{
      const r = location.hash || '#game';
      go(r);
      if(r==='#admin' && isAdmin) currentMode='admin';
      else if(r==='#game') currentMode='player';
      localStorage.setItem('fc_mode', currentMode);
      updateRoleSwitchButton();
    });

    // ---- Admin/Oyuncu düğmesi
    function updateRoleSwitchButton(){
      const btn = $('#btnRoleSwitch');
      if(!btn) return;
      if(!isAdmin){ btn.style.display='none'; return; }
      btn.style.display='inline-block';
      btn.textContent = (currentMode==='admin') ? 'Oyuncu' : 'Admin';
      btn.title = (currentMode==='admin') ? 'Oyuncu moduna geç' : 'Admin moduna geç';
    }
    function switchMode(){
      if(!isAdmin) return;
      currentMode = (currentMode==='admin') ? 'player' : 'admin';
      localStorage.setItem('fc_mode', currentMode);
      if(currentMode==='admin') go('#admin'); else go('#game');
      updateRoleSwitchButton();
    }

    // ================= AUTH =================
    async function doLogin(){
      const email = $('#email').value.trim();
      const password = $('#password').value;
      const { error } = await supa.auth.signInWithPassword({ email, password });
      if(error) return alert(error.message);

      const startAdmin = $('#startAsAdmin')?.checked;
      if(startAdmin) localStorage.setItem('fc_startAdmin','1'); else localStorage.removeItem('fc_startAdmin');

      await boot();
    }
    async function doSignup(){
      const farmName = $('#farmName').value.trim();
      const email = $('#email').value.trim();
      const password = $('#password').value;
      if(!farmName) return alert('Çiftlik adı gerekli.');
      const { data, error } = await supa.auth.signUp({ email, password });
      if(error) return alert(error.message);

      const uid = data.user.id;
      await supa.from('farms').insert({ user_id: uid, farm_name: farmName, tutorial_step: 0 });
      await supa.from('wallets').insert({ user_id: uid, balance: 1000 });
      await supa.from('silos').insert({ user_id: uid, level: 1, capacity: 20 });
      await supa.from('inventory').insert({ user_id: uid, item_name:'tohum', amount:1, category:'bitkisel' });
      await supa.from('profiles').insert({ user_id: uid, email, display_name: farmName });

      const startAdmin = $('#startAsAdmin')?.checked;
      if(startAdmin) localStorage.setItem('fc_startAdmin','1'); else localStorage.removeItem('fc_startAdmin');

      alert('Kayıt başarılı! E‑posta doğrulaması gerekebilir.');
    }

    // ================= BOOT =================
    document.addEventListener('DOMContentLoaded', boot);
    async function boot(){
      bindAuthButtons();
      bindStaticButtons();

      const { data:{ user } } = await supa.auth.getUser();
      if(!user){
        $('#authView').classList.remove('hide');
        $('#appView').classList.add('hide');
        return;
      }
      $('#authView').classList.add('hide');
      $('#appView').classList.remove('hide');
      currentUser = user;

      // admin mi?
      const { data: role } = await supa.from('user_roles').select('role').eq('user_id', user.id).eq('role','admin').maybeSingle();
      isAdmin = !!role;

      await loadFarmHeader(user.id);
      await loadWallet(user.id);
      await loadInventory(user.id);
      await loadSilo(user.id);

      renderLandsInit();
      bindGameButtons();

      // Admin linki ekle ve admin verilerini yükle
      if(isAdmin){
        if(!document.getElementById('adminLink')){
          const a = document.createElement('button');
          a.id='adminLink'; a.className='btn'; a.dataset.route='#admin'; a.textContent='⚙️ Admin';
          a.onclick=()=>go('#admin');
          document.getElementById('nav').appendChild(a);
        }
        await loadAdminAll();
      }

      // Başlangıç modu
      if((location.hash||'')==='#admin' && isAdmin){ currentMode='admin'; }
      else{
        const saved = localStorage.getItem('fc_mode'); if(saved) currentMode=saved;
        const startAdminFlag = localStorage.getItem('fc_startAdmin')==='1';
        if(startAdminFlag && isAdmin) currentMode='admin';
      }

      const roleBtn = $('#btnRoleSwitch');
      if(roleBtn && !roleBtn._bound){ roleBtn._bound=true; roleBtn.onclick=switchMode; }
      updateRoleSwitchButton();

      if(currentMode==='admin' && isAdmin) go('#admin'); else go('#game');

      // Vitrin render (market)
      renderMarketCards();
      renderCryptoCards();
      setTabShowcase('market');
    }

    // ============== LOADERS (GAME) ==============
    async function loadFarmHeader(uid){
      const { data } = await supa.from('farms').select('farm_name,tutorial_step').eq('user_id', uid).single();
      document.getElementById('farmTitle').textContent = data?.farm_name ? `Hoşgeldin ${data.farm_name}!` : 'Hoşgeldin!';
      tutorialStep = data?.tutorial_step || 0;
    }
    async function loadWallet(uid){
      const w = await supa.from('wallets').select('balance').eq('user_id', uid).single();
      document.getElementById('balance').textContent = `💰 ${Number(w.data?.balance||0)} FC`;
    }
    async function loadInventory(uid){
      const inv = await supa.from('inventory').select('item_name,amount').eq('user_id', uid).order('item_name');
      const body = document.getElementById('invBody'); body.innerHTML='';
      (inv.data||[]).forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.item_name}</td><td class="right">${r.amount}</td>`;
        body.appendChild(tr);
      });
    }

    // ============== SILO ==============
    function siloUpgradeCost(){ return Math.round(30*Math.pow(1.6, silo.level-1)); }
    function nextCapacity(){ return 20 + 10*silo.level; }
    async function loadSilo(uid){
      const { data } = await supa.from('silos').select('level,capacity').eq('user_id', uid).maybeSingle();
      if(data) silo=data; else { silo={level:1,capacity:20}; await supa.from('silos').insert({ user_id: uid, level:1, capacity:20 }); }
      await updateSiloBar();
    }
    async function getTotalItems(){
      const { data } = await supa.from('inventory').select('amount').eq('user_id', currentUser.id);
      return (data||[]).reduce((a,b)=>a+(b.amount||0),0);
    }
    async function updateSiloBar(){
      const used = await getTotalItems();
      document.getElementById('siloCap').textContent   = `${used} / ${silo.capacity}`;
      document.getElementById('siloLevel').textContent = `Seviye ${silo.level}`;
      document.getElementById('siloUpgradeInfo').textContent = `Ücret: ${siloUpgradeCost()} FC (Kap.: ${nextCapacity()})`;
    }
    async function upgradeSilo(){
      const w = await supa.from('wallets').select('balance').eq('user_id', currentUser.id).single();
      const nb = Number(w.data?.balance||0) - siloUpgradeCost();
      if(nb<0) return alert('Bakiye yetersiz.');
      await supa.from('wallets').update({ balance: nb }).eq('user_id', currentUser.id);
      await loadWallet(currentUser.id);
      silo.level += 1; silo.capacity = nextCapacity();
      await supa.from('silos').update({ level:silo.level, capacity:silo.capacity }).eq('user_id', currentUser.id);
      await updateSiloBar();
      alert('Silo yükseltildi!');
    }
    function openSilo(){ document.getElementById('siloModal').classList.remove('hide'); renderSiloList('hepsi'); }
    function closeSilo(){ document.getElementById('siloModal').classList.add('hide'); }
    async function renderSiloList(cat){
      const { data } = await supa.from('inventory').select('item_name,amount,category').eq('user_id', currentUser.id).order('item_name');
      const body = document.getElementById('siloBody'); body.innerHTML='';
      (data||[]).forEach(r=>{
        const c = r.category || 'genel';
        if(cat!=='hepsi' && c!==cat) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.item_name}</td><td>${c}</td><td class="right">${r.amount}</td>`;
        body.appendChild(tr);
      });
    }

    // ============== ENVANTER HELPERS ==============
    async function addItem(name, amount){
      const { data } = await supa.from('inventory').select('amount').eq('user_id', currentUser.id).eq('item_name', name).maybeSingle();
      if(data){
        await supa.from('inventory').update({ amount:(data.amount||0)+amount }).eq('user_id', currentUser.id).eq('item_name', name);
      } else {
        await supa.from('inventory').insert({ user_id: currentUser.id, item_name:name, amount, category: (name==='tohum'?'bitkisel':'genel') });
      }
      await loadInventory(currentUser.id);
    }
    async function addItemWithCap(name, amount){
      const used = await getTotalItems();
      if(used + amount > silo.capacity){ alert('Silo kapasitesi dolu!'); return false; }
      await addItem(name, amount);
      await updateSiloBar();
      return true;
    }
    async function removeItem(name, amount){
      const { data } = await supa.from('inventory').select('amount').eq('user_id', currentUser.id).eq('item_name', name).maybeSingle();
      const have = data?.amount || 0;
      if(have < amount) return false;
      const left = have - amount;
      if(left===0){
        await supa.from('inventory').delete().eq('user_id', currentUser.id).eq('item_name', name);
      }else{
        await supa.from('inventory').update({ amount:left }).eq('user_id', currentUser.id).eq('item_name', name);
      }
      await loadInventory(currentUser.id);
      await updateSiloBar();
      return true;
    }

    // ============== TARLALAR ==============
    function renderLandsInit(){ lands=[1,2,3,4].map(i=>({id:i,planted:false,readyAt:null})); renderLands(); }
    function renderLands(){
      const wrap = document.getElementById('lands'); wrap.innerHTML='';
      lands.forEach(slot=>{
        const d=document.createElement('div'); d.className='land'+(slot.planted?' planted':''); d.dataset.id=slot.id;
        if(!slot.planted){
          d.innerHTML = `<div>Boş Tarla #${slot.id}<br><button class="btn">Ekim Yap</button></div>`;
          d.querySelector('button').onclick = ()=>plantOnLand(slot.id);
        }else{
          const left = Math.max(0, Math.ceil((slot.readyAt - now())/1000));
          if(left<=0){
            d.innerHTML = `<div>Hazır #${slot.id}<br><button class="btn">Hasat</button></div>`;
            d.querySelector('button').onclick = ()=>harvestLand(slot.id);
          }else{
            d.innerHTML = `<div>Ekildi #${slot.id}</div><div class="timer">Hasat: ${left}s</div>`;
            const t=setInterval(()=>{
              const l = Math.max(0, Math.ceil((slot.readyAt - now())/1000));
              const tm = d.querySelector('.timer'); if(tm) tm.textContent = `Hasat: ${l}s`;
              if(l<=0){ clearInterval(t); renderLands(); }
            },1000);
          }
        }
        wrap.appendChild(d);
      });
    }
    async function plantOnLand(id){
      const capOk = await addItemWithCap('tohum',0); if(!capOk) return;
      const ok = await removeItem('tohum',1); if(!ok){ document.getElementById('status').textContent='Tohum yok!'; return; }
      const slot = lands.find(l=>l.id===id); slot.planted=true; slot.readyAt=new Date(Date.now()+10000); renderLands();
    }
    async function harvestLand(id){
      const slot = lands.find(l=>l.id===id); if(!slot || !slot.planted || slot.readyAt>now()) return;
      slot.planted=false; slot.readyAt=null; await addItemWithCap('bugday',1); renderLands(); document.getElementById('status').textContent='Hasat tamam!';
    }

    // ============== MARKET (demo) ==============
    function renderMarket(){
      const body=document.getElementById('marketBody'); body.innerHTML='';
      marketItems.forEach((m,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${m.item}</td><td class="right">${m.price}</td><td class="right">${m.amount}</td><td class="right"><button class="btn" data-i="${i}">Satın Al</button></td>`;
        tr.querySelector('button').onclick = ()=>buyFromMarket(i);
        body.appendChild(tr);
      });
    }
    function listToMarket(){
      const item = document.getElementById('sellItem').value;
      const amt  = Math.max(1, parseInt(document.getElementById('sellAmount').value||'1',10));
      const price= Math.max(1, parseInt(document.getElementById('sellPrice').value||'1',10));
      removeItem(item, amt).then(ok=>{
        if(!ok) return alert('Envanter yetersiz.');
        marketItems.push({ item, amount:amt, price }); renderMarket();
        document.getElementById('status').textContent='İlan eklendi.';
      });
    }
    async function buyFromMarket(i){
      const m = marketItems[i]; if(!m) return;
      const w = await supa.from('wallets').select('balance').eq('user_id', currentUser.id).single();
      const nb = Number(w.data?.balance||0) - m.price*m.amount; if(nb<0) return alert('Bakiye yetersiz.');
      await supa.from('wallets').update({ balance: nb }).eq('user_id', currentUser.id);
      await loadWallet(currentUser.id);
      await addItemWithCap(m.item, m.amount);
      marketItems.splice(i,1); renderMarket();
    }

    // ============== KRİPTO (demo) ==============
    function producedSince(d){ if(!d) return 0; const ms = now()-d; return Math.floor(ms/60000); }
    async function collectRig(){
      const w = await supa.from('wallets').select('balance').eq('user_id', currentUser.id).single();
      const gain = Math.max(1, producedSince(rigLast || new Date(Date.now()-60000)));
      await supa.from('wallets').update({ balance: Number(w.data?.balance||0) + gain }).eq('user_id', currentUser.id);
      await loadWallet(currentUser.id); rigLast=now();
      document.getElementById('rigInfo').textContent = `Son toplama: ${rigLast.toLocaleTimeString()} (+${gain} FC)`;
    }

    // ============== ADMIN: özet & listeler ==============
    async function loadAdminAll(){ await Promise.all([loadSummary(), loadAdminFarms(), loadAdminWallets(), loadAdminInventory()]); }
    async function loadSummary(){
      const { count:farmCount } = await supa.from('farms').select('*',{count:'exact',head:true});
      document.getElementById('sumPlayers').textContent = farmCount ?? '—';
      const { data:w } = await supa.from('wallets').select('balance');
      document.getElementById('sumFC').textContent = (w||[]).reduce((a,b)=>a+(b.balance||0),0);
      const { data:s } = await supa.from('silos').select('level');
      document.getElementById('avgSilo').textContent = (s&&s.length)? (s.reduce((a,b)=>a+(b.level||0),0)/s.length).toFixed(1) : '—';
    }
    async function loadAdminFarms(){
      const q = document.getElementById('q')?.value?.trim();
      let qSel = supa.from('farms').select('user_id,farm_name,tutorial_step').order('farm_name');
      if(q) qSel = supa.from('farms').select('user_id,farm_name,tutorial_step').ilike('farm_name','%'+q+'%');
      const { data } = await qSel;
      const tb=document.getElementById('tbodyFarms'); tb.innerHTML='';
      (data||[]).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.user_id}</td><td>${r.farm_name||'-'}</td><td class="right">${r.tutorial_step ?? '-'}</td>`;
        tb.appendChild(tr);
      });
      const btn=document.getElementById('btnSearch');
      if(btn && !btn._bound){ btn._bound=true; btn.onclick=()=>loadAdminFarms(); }
    }
    async function loadAdminWallets(){
      const { data:w } = await supa.from('wallets').select('user_id,balance').order('user_id');
      const { data:s } = await supa.from('silos').select('user_id,level,capacity');
      const mapS=new Map((s||[]).map(x=>[x.user_id,x]));
      const tb=document.getElementById('tbodyWallets'); tb.innerHTML='';
      (w||[]).forEach(r=>{
        const sv=mapS.get(r.user_id)||{};
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.user_id}</td><td class="right">${Number(r.balance||0)}</td><td class="right">${sv.level||'-'}</td><td class="right">${sv.capacity||'-'}</td>`;
        tb.appendChild(tr);
      });
    }
    async function loadAdminInventory(){
      const { data } = await supa.from('inventory').select('user_id,item_name,amount,category').order('user_id');
      const tb=document.getElementById('tbodyInv'); tb.innerHTML='';
      (data||[]).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.user_id}</td><td>${r.item_name}</td><td class="right">${r.amount}</td><td>${r.category||'genel'}</td>`;
        tb.appendChild(tr);
      });
    }

    // ============== ADMIN: rol yönetimi ==============
    async function makeAdminByUserId(uid){
      if(!uid) return alert('user_id girin.');
      const { error } = await supa.from('user_roles').insert({ user_id: uid, role:'admin' });
      if(error){ alert('Hata: ' + error.message); return; }
      alert('Admin verildi.');
    }
    async function removeAdminByUserId(uid){
      if(!uid) return alert('user_id girin.');
      const { error } = await supa.from('user_roles').delete().eq('user_id', uid).eq('role','admin');
      if(error){ alert('Hata: ' + error.message); return; }
      alert('Admin kaldırıldı.');
    }
    async function getUserIdByEmail(email){
      if(!email) return null;
      const { data, error } = await supa.from('profiles').select('user_id').ilike('email', email.trim()).maybeSingle();
      if(error){ console.warn(error); return null; }
      return data?.user_id || null;
    }
    async function makeAdminByEmail(email){
      const uid = await getUserIdByEmail(email);
      if(!uid) return alert('E‑posta bulunamadı: '+email);
      return makeAdminByUserId(uid);
    }
    async function removeAdminByEmail(email){
      const uid = await getUserIdByEmail(email);
      if(!uid) return alert('E‑posta bulunamadı: '+email);
      return removeAdminByUserId(uid);
    }

    // ============== BINDINGS ==============
    function bindAuthButtons(){
      const login=$('#btnLogin'), signup=$('#btnSignup');
      if(login && !login._bound){ login._bound=true; login.onclick=doLogin; }
      if(signup && !signup._bound){ signup._bound=true; signup.onclick=doSignup; }

      const loginAsAdmin = $('#btnLoginAsAdmin');
      if(loginAsAdmin && !loginAsAdmin._bound){
        loginAsAdmin._bound=true;
        loginAsAdmin.onclick = ()=>{ const cb=$('#startAsAdmin'); if(cb) cb.checked=true; $('#btnLogin')?.click(); };
      }
    }
    function bindStaticButtons(){
      const logout=$('#btnLogout');
      if(logout && !logout._bound){ logout._bound=true; logout.onclick=async()=>{ await supa.auth.signOut(); location.reload(); }; }
      const closeBtn=$('#btnCloseSilo'); if(closeBtn && !closeBtn._bound){ closeBtn._bound=true; closeBtn.onclick=closeSilo; }
      $$('#siloTabs .btn').forEach(b=>{ if(!b._bound){ b._bound=true; b.addEventListener('click',()=>renderSiloList(b.dataset.cat)); }});
      $$('#nav .btn').forEach(b=>{ if(!b._bound){ b._bound=true; b.addEventListener('click',()=>go(b.dataset.route)); }});

      // Admin yönetimi butonları
      const bAdd=$('#btnMakeAdmin'), bRem=$('#btnRemoveAdmin'), bAddE=$('#btnMakeAdminEmail'), bRemE=$('#btnRemoveAdminEmail');
      if(bAdd && !bAdd._bound){ bAdd._bound=true; bAdd.onclick=()=>makeAdminByUserId($('#adminUserId').value.trim()); }
      if(bRem && !bRem._bound){ bRem._bound=true; bRem.onclick=()=>removeAdminByUserId($('#adminUserId').value.trim()); }
      if(bAddE && !bAddE._bound){ bAddE._bound=true; bAddE.onclick=()=>makeAdminByEmail($('#adminEmail').value.trim()); }
      if(bRemE && !bRemE._bound){ bRemE._bound=true; bRemE.onclick=()=>removeAdminByEmail($('#adminEmail').value.trim()); }
    }
    function bindGameButtons(){
      const addSeed=$('#btnAddSeed'); if(addSeed && !addSeed._bound){ addSeed._bound=true; addSeed.onclick=async()=>{ const ok=await addItemWithCap('tohum',1); if(ok) $('#status').textContent='1 tohum eklendi.'; }; }
      const plantDemo=$('#btnPlantDemo'); if(plantDemo && !plantDemo._bound){ plantDemo._bound=true; plantDemo.onclick=()=>{ const empty=lands.find(l=>!l.planted); if(empty) plantOnLand(empty.id); else $('#status').textContent='Boş tarla yok.'; }; }
      const sellW=$('#btnSellWheat'); if(sellW && !sellW._bound){ sellW._bound=true; sellW.onclick=()=>{ $('#sellItem').value='bugday'; $('#sellAmount').value=1; listToMarket(); renderMarket(); }; }
      const listBtn=$('#btnList'); if(listBtn && !listBtn._bound){ listBtn._bound=true; listBtn.onclick=()=>{ listToMarket(); renderMarket(); }; }
      const collect=$('#btnCollect'); if(collect && !collect._bound){ collect._bound=true; collect.onclick=collectRig; }
      const openSiloBtn=$('#btnOpenSilo'); if(openSiloBtn && !openSiloBtn._bound){ openSiloBtn._bound=true; openSiloBtn.onclick=openSilo; }
      const upgradeBtn=$('#btnUpgradeSilo'); if(upgradeBtn && !upgradeBtn._bound){ upgradeBtn._bound=true; upgradeBtn.onclick=upgradeSilo; }
    }

    // ============= Vitrin (kartlar & sekmeler) =============
    const SHOWCASE_PRODUCTS = [
      { name: "Organik Zeytin", tag: "Aydın · Erken Hasat", price: "₺220/lt", stock: 38 },
      { name: "Çiğ Süt", tag: "Balıkesir · Günlük", price: "₺35/lt", stock: 120 },
      { name: "Serbest Gezen Yumurta", tag: "Manisa · XL", price: "₺90/10'lu", stock: 64 },
      { name: "Lavanta Balı", tag: "Isparta · 2025", price: "₺360/500g", stock: 42 },
    ];
    const SHOWCASE_TOKENS = [
      { sym:"$FARM", name:"Farm‑Chain", price:1.24, change:+4.2, points:"0,22 16,18 32,18 48,20 64,12 80,10 100,11", color:"#34d399" },
      { sym:"$HONEY",name:"Honey Token", price:0.32, change:-1.8, points:"0,10 16,11 32,9 48,12 64,14 80,16 100,15", color:"#fb7185" },
      { sym:"$GRAIN",name:"Grain Index", price:0.87, change:+0.6, points:"0,18 16,17 32,16 48,17 64,15 80,14 100,13", color:"#34d399" },
    ];
    const tabMarketBtn=document.getElementById('tab-market');
    const tabCryptoBtn=document.getElementById('tab-crypto');
    const badgeMarket=document.getElementById('badge-market');
    const badgeCrypto=document.getElementById('badge-crypto');
    const viewMarket=document.getElementById('view-market');
    const viewCrypto=document.getElementById('view-crypto');

    function setTabShowcase(which){
      if(!viewMarket || !viewCrypto) return;
      const isMarket = which==='market';
      viewMarket.classList.toggle('hide', !isMarket);
      viewCrypto.classList.toggle('hide',  isMarket);
      tabMarketBtn?.classList.toggle('active', isMarket);
      tabCryptoBtn?.classList.toggle('active', !isMarket);
      badgeMarket?.classList.toggle('active', isMarket);
      if(badgeCrypto) badgeCrypto.style.opacity = isMarket ? '.8' : '1';
    }
    function renderMarketCards(){
      if(!viewMarket) return;
      viewMarket.innerHTML = SHOWCASE_PRODUCTS.map(p=>`
        <article class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <h4 style="margin:0;font-size:20px;">${p.name}</h4>
            <span class="tag">${p.tag}</span>
          </div>
          <div class="media" style="height:120px;border-radius:14px;background:rgba(255,255,255,.05);margin:10px 0;"></div>
          <div class="actions" style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div><strong style="color:#fff">${p.price}</strong> · Stok: ${p.stock}</div>
            <button class="btn em">Sepete Ekle</button>
          </div>
        </article>
      `).join('');
    }
    function renderCryptoCards(){
      if(!viewCrypto) return;
      viewCrypto.innerHTML = SHOWCASE_TOKENS.map(t=>`
        <article class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div>
              <div style="display:flex;gap:8px;align-items:center;">
                <span class="tag">${t.sym}</span>
                <h4 style="margin:0;font-size:18px;">${t.name}</h4>
              </div>
              <p style="margin:6px 0 0;color:#cfd;">
                Fiyat: <strong style="color:#fff">$${t.price.toFixed(2)}</strong>
                <span style="margin-left:8px;color:${t.change>=0?'#b8ffda':'#fb7185'}">${t.change>=0?'+':''}${t.change.toFixed(1)}%</span>
              </p>
            </div>
            <div class="logo" style="width:38px;height:38px;color:#e5fff6;background:linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.12));border-radius:10px;display:grid;place-items:center;">⚙️</div>
          </div>
          <svg viewBox="0 0 100 32" style="width:100%;height:72px;border-radius:14px;background:rgba(0,0,0,.35);padding:8px;">
            <polyline fill="none" stroke="${t.color}" stroke-width="2" points="${t.points}" />
          </svg>
          <div style="display:flex;gap:8px;margin-top:10px;">
            <button class="btn">Satın Al</button>
            <button class="btn em">Takas Et</button>
          </div>
        </article>
      `).join('');
    }
    if(tabMarketBtn){
      ['click'].forEach(ev=>{
        tabMarketBtn.addEventListener(ev, ()=>setTabShowcase('market'));
        tabCryptoBtn.addEventListener(ev, ()=>setTabShowcase('crypto'));
        badgeMarket?.addEventListener(ev, ()=>setTabShowcase('market'));
        badgeCrypto?.addEventListener(ev, ()=>setTabShowcase('crypto'));
      });
    }
  </script>
</body>
</html>
