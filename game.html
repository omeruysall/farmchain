<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>FarmChain â€“ Oyun</title>
  <style>
    /* Arka plan ve temel stiller */
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: #e9eef3;
      background: #0a0d18;  /* Index ile aynÄ± arka plan */
      overflow-x: hidden;
    }
    button {
      border: 1px solid rgba(255,255,255,.2);
      background: transparent;
      border-radius: 10px;
      color: #e9eef3;
      padding: .45rem .7rem;
      cursor: pointer;
    }
    button:hover {
      background: rgba(255,255,255,.08);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      color: #dbe4f3;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    th {
      text-align: left;
    }
  </style>
</head>
<body onload="loadFarm()">

  <!-- Ãœst kÄ±sÄ±m -->
  <header style="display:flex;gap:16px;align-items:center;justify-content:center;margin:20px auto;">
    <h2 id="farmTitle" style="margin:0">YÃ¼kleniyorâ€¦</h2>
    <span id="balance" style="padding:.35rem .6rem;border:1px solid rgba(255,255,255,.15);border-radius:10px;">ðŸ’° â€”</span>
    <button onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
  </header>

  <!-- Ä°Ã§erik -->
  <main style="max-width:980px;margin:0 auto;padding:0 16px">
    <section>
      <h3 style="margin:.2rem 0 0.6rem">ðŸŒ± Envanter</h3>
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <button id="btnAddSeed">+ Tohum Ekle</button>
        <button id="btnPlant">ðŸŒ¾ Ekim Yap (Demo 10sn)</button>
      </div>
      <table id="invTable">
        <thead>
          <tr>
            <th>ÃœrÃ¼n</th>
            <th style="text-align:right">Miktar</th>
          </tr>
        </thead>
        <tbody id="invBody"></tbody>
      </table>
      <div id="status" style="margin-top:10px;color:#9fc"></div>
    </section>
  </main>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const supa = supabase.createClient(
      "https://gukdmxepdgwrwniectnq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd1a2RteGVwZGd3cnduaWVjdG5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NzgyODAsImV4cCI6MjA3MTQ1NDI4MH0.57j4LbCHdhoaYl05PBTRjNyQAV3SxvL07GUredTDWZU"
    );

    // CÃ¼zdan + envanter yÃ¼kle
    async function loadWalletAndInv(userId){
      // Bakiye
      const w = await supa.from('wallets').select('balance').eq('user_id', userId).single();
      document.getElementById('balance').textContent = `ðŸ’° ${Number(w.data?.balance ?? 0)} $FARM`;

      // Envanter
      const inv = await supa.from('inventory').select('item_name, amount').eq('user_id', userId).order('item_name');
      const body = document.getElementById('invBody');
      body.innerHTML = '';
      (inv.data || []).forEach(row=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.item_name}</td>
                        <td style="text-align:right">${row.amount}</td>`;
        body.appendChild(tr);
      });
    }

    // Ekim demo: 10sn sonra 1 "buÄŸday" ekle
    async function plantDemo(userId){
      const status = document.getElementById('status');
      status.textContent = 'Ekim baÅŸladÄ±â€¦ 10sn sonra hasat edilecek.';
      await new Promise(r=>setTimeout(r, 10000));
      await addItem(userId, 'bugday', 1);
      status.textContent = 'Hasat tamam! Envantere 1 buÄŸday eklendi.';
      loadWalletAndInv(userId);
    }

    // Envantere Ã¼rÃ¼n ekle (upsert)
    async function addItem(userId, name, amount){
      const { data } = await supa.from('inventory')
        .select('amount')
        .eq('user_id', userId)
        .eq('item_name', name)
        .single();

      if(data){
        await supa.from('inventory')
          .update({ amount: (data.amount || 0) + amount })
          .eq('user_id', userId).eq('item_name', name);
      } else {
        await supa.from('inventory')
          .insert({ user_id: userId, item_name: name, amount });
      }
    }

    // Ana yÃ¼kleme
    async function loadFarm(){
      const { data: { user } } = await supa.auth.getUser();
      if(!user){ window.location.href = "index.html"; return; }

      const farm = await supa.from('farms').select('farm_name').eq('user_id', user.id).single();
      document.getElementById("farmTitle").innerText =
        farm.data?.farm_name ? `HoÅŸgeldin ${farm.data.farm_name}!` : 'HoÅŸgeldin!';

      await loadWalletAndInv(user.id);

      // Butonlar
      document.getElementById('btnAddSeed').onclick = async ()=>{
        await addItem(user.id, 'tohum', 1);
        loadWalletAndInv(user.id);
      };
      document.getElementById('btnPlant').onclick = ()=> plantDemo(user.id);
    }

    function logout(){
      supa.auth.signOut().then(()=> window.location.href="index.html");
    }
  </script>
</body>
</html>
